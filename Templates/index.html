{% extends "base.html" %}
{% block content %}

<!-- ALERTA DE FLASH MESSAGE -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<h2 class="mb-4">Transações</h2>

<!-- 🔹 FORMULÁRIO DE FILTRO -->
<form method="GET" action="{{ url_for('index') }}" class="row g-3 mb-4">
  <div class="col-auto">
    <label for="month" class="form-label">Mês</label>
    <input type="number" class="form-control" id="month" name="month" min="1" max="12"
           value="{{ request.args.get('month', current_month) }}">
  </div>
  <div class="col-auto">
    <label for="year" class="form-label">Ano</label>
    <input type="number" class="form-control" id="year" name="year"
           value="{{ request.args.get('year', current_year) }}">
  </div>
  <div class="col-auto align-self-end">
    <button type="submit" class="btn btn-primary">Filtrar</button>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Limpar</a>
  </div>
</form>
<!-- 🔹 FIM DO FORMULÁRIO DE FILTRO -->

<table class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th>Data</th>
      <th>Descrição</th>
      <th>Categoria</th>
      <th>Forma de Pagamento</th>
      <th>Valor</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody>
    {% for t in transactions %}
    <tr>
      <td>{{ t.date.strftime('%d/%m/%Y') }}</td>
      <td>{{ t.description }}</td>
      <td>
        <span class="badge" style="background-color: {{ t.category.color if t.category else '#6c757d' }}">
          {{ t.category.name if t.category else '' }}
        </span>
      </td>
      <td>{{ t.payment_method }}</td>
      <td class="{{ 'text-success' if t.category and t.category.type=='income' else 'text-danger' }}">
        R$ {{ '%.2f'|format(t.amount) }}
      </td>
      <td>
        <a href="{{ url_for('edit_transaction', id=t.id) }}" class="btn btn-sm btn-warning">Editar</a>
        <form action="{{ url_for('delete_transaction', id=t.id) }}" method="post" style="display:inline;">
          <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Excluir esta transação?')">Excluir</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<div class="mt-4">
  <h3>Resumo do mês {{ month }}</h3>
  <ul class="list-group">
    <li class="list-group-item">Total Receitas: <span class="text-success fw-bold">R$ {{ '%.2f'|format(total_income) }}</span></li>
    <li class="list-group-item">Total Despesas: <span class="text-danger fw-bold">R$ {{ '%.2f'|format(total_expense) }}</span></li>
    <li class="list-group-item">Saldo: <span class="fw-bold">{{ '%.2f'|format(balance) }}</span></li>
  </ul>
</div>

<div class="mt-4">
  <a href="{{ url_for('new_transaction') }}" class="btn btn-primary">+ Nova Transação</a>
  <a href="{{ url_for('categories_view') }}" class="btn btn-secondary">Gerenciar Categorias</a>
</div>

<div class="mt-4">
  <a href="{{ url_for('export_csv') }}" class="btn btn-outline-primary">Exportar CSV (Detalhado)</a>
  <a href="{{ url_for('export_excel') }}" class="btn btn-outline-success">Exportar Excel (Detalhado)</a>
  <a href="{{ url_for('export_summary_csv') }}" class="btn btn-outline-info">Resumo CSV por Categoria</a>
  <a href="{{ url_for('export_summary_excel') }}" class="btn btn-outline-warning">Resumo Excel por Categoria</a>
</div>

<form action="{{ url_for('reset_data') }}" method="post" onsubmit="return confirm('Tem certeza que deseja apagar tudo?');">
  <button type="submit" class="btn btn-danger mt-3">Resetar Tudo</button>
</form>

{% endblock %}